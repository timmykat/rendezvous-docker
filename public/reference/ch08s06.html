<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Allocating Your Own Images</title><link rel="stylesheet" type="text/css" href="ofxStyle.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.77.1" /><link rel="home" href="index.html" title="The OFX Image Effect Plug-in API, 1.3, Programming Reference." /><link rel="up" href="ch08.html" title="Chapter 8. Images and Clips" /><link rel="prev" href="ch08s05.html" title="Clips and Pixel Aspect Ratios" /><link rel="next" href="ch09.html" title="Chapter 9. Effect Parameters" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Allocating Your Own Images</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch08s05.html">Prev</a> </td><th width="60%" align="center">Chapter 8. Images and Clips</th><td width="20%" align="right"> <a accesskey="n" href="ch09.html">Next</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="ImageEffectsMemoryAllocation"></a>Allocating Your Own Images</h2></div></div></div><p>
	Under OFX, the  images you fetch from the host have already had their memory allocated. 
	If a plug-in needs to define its owns temporary images buffers during processing, or to cache 
	images between actions, then the plug-in should use the image memory allocation routines
	declared in OfxImageEffectSuiteV1. The reason for this is that many host have special 
	purpose memory pools they manage to optimise memory usage as images can chew up memory 
	very rapidly (eg: a 2K RGBA floating point film plate is 48 MBytes).
      </p><p>
	For general purpose (as in less than a megabyte) memory allocation, you should use the memory suite in ofxMemory.h
      </p><p>
	OFX provides four functions to deal with image memory. These are,
	</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="re31.html" title="OfxImageEffectSuiteV1::imageMemoryAlloc"><code class="code">OfxImageEffectSuiteV1::imageMemoryAlloc</code></a></li><li class="listitem"><a class="link" href="re32.html" title="OfxImageEffectSuiteV1::imageMemoryFree"><code class="code">OfxImageEffectSuiteV1::imageMemoryFree</code></a></li><li class="listitem"><a class="link" href="re33.html" title="OfxImageEffectSuiteV1::imageMemoryLock"><code class="code">OfxImageEffectSuiteV1::imageMemoryLock</code></a></li><li class="listitem"><a class="link" href="re34.html" title="OfxImageEffectSuiteV1::imageMemoryUnlock"><code class="code">OfxImageEffectSuiteV1::imageMemoryUnlock</code></a></li></ul></div><p>
      </p><p>
	A host needs to be able defragment its image memory pool, potentially moving the contents
	of the memory you have allocated to another address, even saving it to disk under its own
	virtual memory caching scheme. Because of this when you request a block of memory, you are 
	actually returned a handle to the memory, not the memory itself. To use the memory you must
	first lock the memory via the imageMemoryLock call, which will then return a pointer to the 
	locked block of memory.
      </p><p>
	During an single action, there is generally no need to lock/unlock any temporary buffers you 
	may have allocated via this mechanism. However image memory that is cached between actions 
	should always be unlocked while it is not actually being used. This allows a host to do what 
	it needs to do to optimise memory usage.
      </p><p>
	Note that locks and unlocks nest. This implies that there is a lock count kept on 
	the memory handle, also not that this lock count cannot be negative. So unlocking a completely unlocked handle has no effect.
      </p><p>
      An example is below....
      </p><div class="blockquote"><blockquote class="blockquote"><pre class="programlisting">
  // get a memory handle
  OfxImageMemoryHandle memHandle;
  gEffectSuite-&gt;imageMemoryAlloc(0, imageSize, &amp;memHandle);

  // lock the handle and get a pointer
  void *memPtr;
  gEffectSuite-&gt;imageMemoryLock(memHandle, &amp;memPtr);
  
  ... // do stuff with our pointer

  // now unlock it
  gEffectSuite-&gt;imageMemoryUnlock(memHandle);

  
  // lock it again, note that this may give a completely different address to the last lock
  gEffectSuite-&gt;imageMemoryLock(memHandle, &amp;memPtr);
  
  ... // do more stuff

  // unlock it again
  gEffectSuite-&gt;imageMemoryUnlock(memHandle);

  // delete it all
  gEffectSuite-&gt;imageMemoryFree(memHandle);</pre></blockquote></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch08s05.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ch08.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="ch09.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Clips and Pixel Aspect Ratios </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 9. Effect Parameters</td></tr></table></div></body></html>